# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy staging (Azure)

# on:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - "platform/**"
  #     - ".github/workflows/deploy-staging-azure.yml"

on:
  registry_package:
  
jobs:
  deploy:
    # if: ${{ github.event.registry_package.package_version.container_metadata.tag.name == 'main' }}
    runs-on: ubuntu-latest
    concurrency:
      group: deploy:${{ github.ref }}
    environment:
      name: "Staging (Azure)"
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Echo container data
        run: echo ${{ github.event.registry_package.package_version.container_metadata }}
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Deploy New Revision
        run: az containerapp revision copy \
               --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
               --resource-group ${{ secrets.AZURE_CONTAINER_APP_RESOURCE_GROUP }} \
               --image ghcr.io/atlosdotorg/atlos@${{ github.event.registry_package.package_version.container_metadata.digest }}